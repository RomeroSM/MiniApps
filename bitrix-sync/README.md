# Синхронизация справочников с Bitrix24

Приложение для синхронизации справочников из Bitrix24 в локальную базу данных MySQL.

## Описание

Приложение синхронизирует следующие справочники из Bitrix24 в локальную БД:
- Города (City)
- Объекты (Object)
- Категории нарушений (ViolationCategory)
- Нарушения (Violation)
- Пользователи (User)

Синхронизация происходит из Bitrix24 в локальную БД (односторонняя). Для связи записей используется поле `btxid`, которое хранит ID записи из Bitrix24.

## Установка

1. Перейдите в директорию проекта:
```bash
cd bitrix-sync
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Настройте переменные окружения в корневом `.env` файле проекта:
   
   Приложение использует корневой `.env` файл из директории `C:\Python\MiniApps\.env`.
   Убедитесь, что в нем указаны следующие переменные для синхронизации с Bitrix24:
   
   - `BITRIX_WEBHOOK_URL` - URL webhook из вашего Bitrix24 (обязательно)
   - `MYSQL_HOST` - хост базы данных MySQL (по умолчанию: localhost)
   - `MYSQL_PORT` - порт базы данных MySQL (по умолчанию: 3306)
   - `MYSQL_USER` - пользователь MySQL
   - `MYSQL_PASSWORD` - пароль MySQL
   - `MYSQL_DATABASE` - имя базы данных (по умолчанию: telegram_miniapp)
   - `SYNC_SCHEDULE` - расписание синхронизации в cron-формате (по умолчанию: `0 0 * * *` - раз в сутки в полночь)
   - `LOG_LEVEL` - уровень логирования (по умолчанию: INFO)
   
   Если корневого `.env` файла нет, создайте его на основе `.env.example` из корневой директории проекта.

## Конфигурация

### Получение Webhook URL из Bitrix24

1. Войдите в ваш Bitrix24 портал
2. Перейдите в Настройки -> Разработчикам -> Другое
3. Выберите "Входящий вебхук"
4. Создайте новый вебхук с нужными правами доступа
5. Скопируйте URL вебхука в `.env` файл

### Параметры базы данных

Приложение использует ту же базу данных, что и основной проект. Убедитесь, что:
- База данных создана
- Таблицы созданы (модели из родительского проекта)
- Колонка `btxid` существует во всех справочных таблицах

## Использование

### CLI режим (ручной запуск)

Запуск синхронизации всех справочников:
```bash
python cli.py
```

Синхронизация выбранных справочников:
```bash
# Только города
python cli.py --sync city

# Несколько справочников
python cli.py --sync city object category

# С указанием webhook URL
python cli.py --webhook-url https://your-domain.bitrix24.ru/rest/1/code/
```

Подробный вывод:
```bash
python cli.py --verbose
```

### Сервисный режим (автоматическая синхронизация)

Запуск сервиса с расписанием:
```bash
python service.py
```

Сервис будет запускать синхронизацию автоматически согласно расписанию, указанному в `SYNC_SCHEDULE` (по умолчанию - раз в сутки в полночь).

Для остановки сервиса нажмите `Ctrl+C`.

## Расписание (cron-формат)

Расписание указывается в формате cron:
```
минута час день месяц день_недели
```

Примеры:
- `0 0 * * *` - каждый день в полночь (по умолчанию)
- `0 2 * * *` - каждый день в 2:00 ночи
- `0 9,17 * * *` - в 9:00 и 17:00 каждый день
- `0 0 * * 0` - каждое воскресенье в полночь
- `0 */6 * * *` - каждые 6 часов
- `0 * * * *` - каждый час (в начале часа)

## Запуск через cron на хосте

Если вы хотите использовать cron на хосте вместо встроенного планировщика в контейнере:

### Linux/Mac

1. Сделайте скрипт исполняемым:
```bash
chmod +x bitrix-sync/sync-cron.sh
```

2. Добавьте задачу в crontab:
```bash
crontab -e
```

3. Добавьте строку (синхронизация каждый день в полночь):
```cron
0 0 * * * /полный/путь/к/проекту/bitrix-sync/sync-cron.sh >> /var/log/bitrix-sync.log 2>&1
```

### Windows (Task Scheduler)

1. Откройте "Планировщик задач" (Task Scheduler)
2. Создайте новую задачу
3. Настройте триггер: ежедневно в 00:00
4. Действие: запуск программы
   - Программа: `powershell.exe`
   - Аргументы: `-File "C:\полный\путь\к\проекту\bitrix-sync\sync-cron.ps1"`
5. Сохраните задачу

**Примечание:** При использовании cron на хосте рекомендуется остановить сервисный режим в docker-compose и запускать синхронизацию только через cron.

## Настройка маппинга данных

Для каждого справочника необходимо настроить:
1. Метод Bitrix24 API - в файле соответствующего синхронизатора измените метод `get_bitrix_method()`
2. Маппинг полей - в методе `get_field_map()` укажите соответствие полей Bitrix24 → БД

### Пример настройки синхронизатора

Отредактируйте файл `app/syncers/city_syncer.py`:

```python
def get_bitrix_method(self) -> str:
    """Метод Bitrix24 API для получения городов"""
    # Замените на реальный метод вашего Bitrix24
    return 'crm.type.list'  # или другой метод

def get_field_map(self) -> Dict[str, str]:
    """Маппинг полей Bitrix24 -> БД"""
    return {
        'NAME': 'name',  # Поле NAME в Bitrix24 -> name в БД
        # Добавьте другие поля при необходимости
    }
```

## Структура проекта

```
bitrix-sync/
├── app/
│   ├── __init__.py
│   ├── config.py              # Конфигурация
│   ├── database.py            # Подключение к БД
│   ├── bitrix_client.py       # Клиент Bitrix24 API
│   ├── sync_engine.py         # Движок синхронизации
│   ├── scheduler.py           # Планировщик задач
│   └── syncers/               # Синхронизаторы
│       ├── base_syncer.py
│       ├── city_syncer.py
│       ├── object_syncer.py
│       ├── category_syncer.py
│       ├── violation_syncer.py
│       └── user_syncer.py
├── cli.py                     # CLI интерфейс
├── service.py                 # Сервисный режим
├── requirements.txt           # Зависимости
├── .env.example               # Пример конфигурации
└── README.md                  # Документация
```

## Логирование

Логи сохраняются в:
- Консоль (stdout) - при CLI режиме
- Файл `bitrix-sync.log` - при сервисном режиме

Уровень логирования настраивается через переменную `LOG_LEVEL` в `.env` файле.

## Обработка ошибок

Приложение обрабатывает следующие ошибки:
- Ошибки подключения к Bitrix24 API
- Ошибки подключения к базе данных
- Ошибки валидации данных
- Ошибки синхронизации отдельных записей (не прерывают весь процесс)

Результаты синхронизации выводятся с указанием количества созданных, обновленных записей и ошибок.

## Зависимости между справочниками

При синхронизации учитывается порядок зависимостей:
1. Города (City) - независимый справочник
2. Категории нарушений (ViolationCategory) - независимый справочник
3. Объекты (Object) - зависят от городов
4. Нарушения (Violation) - зависят от категорий
5. Пользователи (User) - независимый справочник

При автоматической синхронизации справочники синхронизируются в правильном порядке.

## Примечания

- Все запросы к Bitrix24 выполняются через POST метод с использованием библиотеки `requests`
- Приложение переиспользует модели из родительского проекта (`../models.py`)
- Синхронизация создает записи, если их нет, или обновляет существующие по полю `btxid`
- Для пользователей (User) требуется наличие `tg_id` и `secret_key` - эти поля не синхронизируются из Bitrix24

## Поддержка

При возникновении проблем проверьте:
1. Правильность URL webhook Bitrix24
2. Наличие прав доступа у webhook к нужным данным
3. Параметры подключения к базе данных
4. Логи приложения для диагностики ошибок
